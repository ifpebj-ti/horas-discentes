name: CI/CD - Lint, Build, Scan (sem push para GHCR)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: 'front/package-lock.json'

      - name: Instalar dependências do Frontend
        working-directory: ./front
        run: npm install

      - name: Executar ESLint
        working-directory: ./front
        run: npm run lint

      - name: Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Formatar código .NET
        working-directory: ./Back
        run: dotnet format Back.sln --verify-no-changes

  build:
    needs: lint
    runs-on: ubuntu-latest
    outputs:
      frontend_tag: horas-discentes-frontend:local
      backend_tag: horas-discentes-backend:local

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Garantir que a pasta public exista no contexto de build
        run: mkdir -p ./front/public

      - name: Build da imagem Docker do Frontend (local)
        uses: docker/build-push-action@v5
        with:
          context: ./front
          file: ./front/Dockerfile
          push: false
          load: true               
          tags: horas-discentes-frontend:local

      - name: Build da imagem Docker do Backend (local)
        uses: docker/build-push-action@v5
        with:
          context: ./Back
          file: ./Back/Dockerfile
          push: false
          load: true              
          tags: horas-discentes-backend:local

  scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends apt-transport-https ca-certificates gnupg lsb-release
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan da imagem Docker do Frontend (local)
        run: trivy image --severity CRITICAL --exit-code 1 horas-discentes-frontend:local

      - name: Scan da imagem Docker do Backend (local)
        run: trivy image --severity CRITICAL --exit-code 1 horas-discentes-backend:local
